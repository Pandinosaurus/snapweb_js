<!doctype html>
<html lang="en">
<head>
    <title>Face tracker</title>
    <meta charset="utf-8">
    <style>
        #container {
            position: relative;
        }

        #canvas {
            position: absolute;
            left: 0;
            top: 0;
        }

        #videoel {
            -o-transform : scaleX(-1);
            -webkit-transform : scaleX(-1);
            transform : scaleX(-1);
            -ms-filter : fliph; /*IE*/
            filter : fliph; /*IE*/
        }
    </style>
</head>
<body>
<script src="./js/utils.js"></script>
<script src="./js/clmtrackr.js"></script>
<script src="./js/model_pca_20_svm.js"></script>
<div id="content">
    <h2>Example</h2>

    <div id="container">
        <video id="videoel" width="400" height="300" preload="auto" loop></video>
        <canvas id="canvas" width="368" height="288"></canvas>
    </div>
    <p>Printing coordinates of the first 10 points in facial features:</p>

    <p id="positions"></p>
    <script>
        var vid = document.getElementById('videoel');

        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

        // check for camerasupport
        if (navigator.getUserMedia) {
            // set up stream
            var videoSelector = {video : true};
            if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
                var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
                if (chromeVersion < 20) {
                    videoSelector = "video";
                }
            };

            navigator.getUserMedia(videoSelector, function( stream ) {
                if (vid.mozCaptureStream) {
                    vid.mozSrcObject = stream;
                } else {
                    vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
                }
                vid.play();
            }, function() {
                alert("There was some problem trying to fetch video from your webcam, using a fallback video instead.");
            });
        } else {
            alert("Your browser does not seem to support getUserMedia, using a fallback video instead.");
        }

        var ctracker = new clm.tracker();
        ctracker.init(pModel);
        ctracker.start(vid);

        function positionLoop() {
            requestAnimationFrame(positionLoop);
            var positions = ctracker.getCurrentPosition();
            // do something with the positions ...
            // print the positions
            var positionString = "";
            if (positions) {
                for (var p = 0; p < 10; p++) {
                    positionString += "featurepoint " + p + " : [" + positions[p][0].toFixed(2) + "," + positions[p][1].toFixed(2) + "]<br/>";
                }
                document.getElementById('positions').innerHTML = positionString;
            }
        }
        positionLoop();

        var canvasInput = document.getElementById('canvas');
        var cc = canvasInput.getContext('2d');
        function drawLoop() {
            requestAnimationFrame(drawLoop);
            cc.clearRect(0, 0, canvasInput.width, canvasInput.height);
            ctracker.draw(canvasInput);
        }
        drawLoop();
    </script>
</div>
</body>
</html>
